# AI小说创作的递归工作流
本文档旨在阐述一种基于AI的、结构化、可递归执行的小说创作方法。该方法通过将"创作一部小说"的宏大目标, 持续分解为更小、更易于管理的子任务, 直至任务变为可直接执行的"原子任务", 最终完成整部作品。

## 理念
整个创作过程是一个递归循环, 其核心是 "精炼 -> 判断 -> (执行 | 分解)"。系统接收一个任务, 首先精炼和明确其目标, 然后判断它是否为"原子任务"。如果是, 则直接执行；如果不是(即"复杂任务"), 则将其分解为一系列子任务, 并对每个子任务递归地调用此流程。

## 任务类型
- 搜索任务 (Search Task): 负责收集信息、研究背景、获取创作所需素材。
- 设计任务 (Design Task): 负责规划故事结构, 如世界观、情节大纲、人物设定等。
- 写作任务 (Writing Task): 负责产出小说的具体文本内容。

## 概念
- 原子任务 (Atomic Task): 无需分解、可直接执行。
- 复杂任务 (Complex Task): 需要被分解的任务。

## 工作流程
对于任何给定的任务, 系统都会执行以下递归流程 (`flow_story_write`)：

### 1. 任务启动与预检
- 任务精炼: 优化和明确当前任务的目标和要求。

### 2. 原子性判断
- 硬性规则:
    - 写作任务: 如果一个写作任务没有前置的、平级的、已完成的设计任务, 它被视为复杂任务。这确保了"先设计, 后写作"。
    - 设计任务: 如果一个设计任务的父任务和祖父任务都是设计任务(即设计任务分解到第三层), 它被视为原子任务。
    - 搜索任务: 如果一个搜索任务的父任务也是搜索任务(即搜索任务分解到第二层), 它被视为原子任务。
- AI判断: 如果不满足以上硬性规则, 则由一个专门的AI模型 (`task_atom`) 来最终判断其原子性。

### 3. 流程分支
- 根据原子性判断的结果, 流程进入两个分支之一：

#### 分支A：执行原子任务

##### `design` 任务
- 执行设计任务。根据不同的层级, 调用不同的设计提示词：

###### 层级: 全书
- 战略设计 (Strategic Design): 定义小说的核心概念、世界观、主线情节和核心角色。
- 核心目标: 产出全书的核心设定、角色和情节大纲。
- 工作流程: 路由 + 四步法 (Guideline -> Draft -> Critic -> Refine)
    1.  任务路由 (Routing): 分析任务, 指派给最合适的专家(战略、情节、系统、角色、通用)。
    2.  生成指南 (Guideline): 专家根据任务, 生成专业的`设计指南`。
    3.  编写草稿 (Draft): 依据`设计指南`, 编写包含具体创意的`设计草稿`。
    4.  评审优化 (Critic): 对照`设计指南`, 审查`设计草稿`并提出具体的修改建议。
    5.  整合终稿 (Refine): 整合`指南`、`草稿`和`修改建议`, 产出最终的设计方案。
- 提示词：
    - `book/route_expert.py`: 任务路由: 分析任务, 路由至`strategist`, `headwriter`, `system`, `character`, `generalist`。
    - `book/1_guideline_*.py`: 指南生成: 各领域专家生成设计指南。
    - `book/2_draft.py`: 草稿编写: 依据指南, 编写设计草稿。
    - `book/3_critic.py`: 草稿评审: 依据指南, 评审草稿并提供修改建议。
    - `book/4_refine.py`: 整合终稿: 整合所有输入, 生成最终方案。

###### 层级: 卷、幕、章
- 结构设计 (Structural Design): 将战略层设计分解为具体的卷、章叙事结构。
- 核心目标: 将战略设计分解为中观叙事单元, 明确各单元的功能和关键事件。
- 工作流程: Guideline -> Draft -> Refine
    1.  生成指南 (Guideline): 承接上层设计, 为当前单元(卷/章)生成`结构设计指南`。
    2.  编写草稿 (Draft): 依据指南, 将关键事件分解为包含情节要点的`结构草稿`。
    3.  整合终稿 (Refine): 审查并优化草稿的节奏与逻辑, 产出最终的`结构设计方案`。
- 提示词：
    - `struct/1_guideline.py`: 指南生成: 为卷/章生成结构设计指南。
    - `struct/2_draft.py`: 草稿编写: 依据指南, 编写包含情节要点的结构草稿。
    - `struct/3_refine.py`: 整合终稿: 优化草稿, 产出最终结构方案。

###### 层级: 场景、节拍、段落
- 执行设计 (Execution Design): 将结构层情节分解为可直接写作的场景和段落。
- 核心目标: 将情节要点转化为具体的场景、动作、对话和描写。
- 工作流程: 两步法 (Plan -> Draft)
    1.  场景规划 (Plan): 将情节要点分解为具体的"场景节拍", 明确每个节拍的目标、行为和对话。
    2.  正文写作 (Draft): 依据"场景节拍"完成小说正文的写作。
- 提示词：
    - `execute/1_plan.py`: 场景规划: 将情节要点分解为"场景节拍"。
    - `execute/2_draft.py`: 正文写作: 依据"场景节拍", 完成小说正文。

##### `search` 任务
- 信息搜索。

##### `write` 任务
1.  `task_write_plan` (规划写作步骤)
2.  `task_write_draft` (生成初稿)
3.  `task_write_critic` (对初稿进行批判性评估)
4.  `task_write_refine` (根据评估意见修改和润色稿件)
5.  `task_summary` (为完成的文稿生成摘要)
6.  `task_write_review` (在"章"级别对内容进行审查, 场景、段落等更细粒度不触发)

#### 分支B：分解复杂任务
- 根据类型和复杂原因, 调用不同的分解策略：

##### `write` 任务

###### 原因：设计缺失
- 生成一系列 `design` 和 `search` 子任务 + 一个写作任务(占位符)。
- 分解策略: 根据叙事层级调用不同的提示词。

####### 层级: 全书
- 工作流: 任务提案 -> 评审与结构化 -> 格式化生成
    1.  任务提案: (`plan/book/write_1_planner.py`)
    2.  评审与结构化: (`plan/book/write_2_critic.py`)
    3.  格式化生成: (`plan/book/write_3_synthesizer.py`)

####### 层级: 卷、幕、章
- 工作流: 任务提案 -> 评审与结构化 -> 格式化生成
    1.  任务提案: (`plan/struct/write_1_planner.py`)
    2.  评审与结构化: (`plan/struct/write_2_critic.py`)
    3.  格式化生成: (`plan/struct/write_3_synthesizer.py`)

####### 层级: 场景、节拍、段落
- 工作流: 规划草案 -> 格式化生成
    1.  规划草案: (`plan/execute/write_1_planner.py`)
    2.  格式化生成: (`plan/execute/write_2_synthesizer.py`)

###### 原因：字数过多
- 已有设计方案, 进行层级结构划分, 分解为下一层级的一系列 `write` 子任务。
- hierarchy/hierarchy_1.py

##### `design` 任务
- 分解为一系列 `design` 和 `search` 子任务。
- 分解策略: 根据叙事层级调用不同的设计规划。

####### 层级: 全书
- 工作流: 任务提案 -> 评审与结构化 -> 格式化生成
    1.  任务提案: (`plan/book/design_1_planner.py`)
    2.  评审与结构化: (`plan/book/design_2_critic.py`)
    3.  格式化生成: (`plan/book/design_3_synthesizer.py`)

####### 层级: 卷、幕、章
- 工作流: 任务提案 -> 评审与结构化 -> 格式化生成
    1.  任务提案: (`plan/struct/design_1_planner.py`)
    2.  评审与结构化: (`plan/struct/design_2_critic.py`)
    3.  格式化生成: (`plan/struct/design_3_synthesizer.py`)

####### 层级: 场景、节拍、段落
- 工作流: 规划草案 -> 格式化生成
    1.  规划草案: (`plan/execute/design_1_planner.py`)
    2.  格式化生成: (`plan/execute/design_2_synthesizer.py`)


##### `search` 任务
- 分解为一系列 `search` 子任务。

### 4. 递归
- 递归调用: 任务分解后, 系统会对产生的每一个子任务, 递归地调用 `flow_story_write` 流程(从步骤1开始)。

### 5. 聚合
- 结果聚合: 当一个父任务的所有子任务都执行完毕后, 系统会执行一个"聚合"步骤, 将子任务的结果汇总到父任务中。
- `design`: `task_aggregate_design`
- `search`: `task_aggregate_search`
- `write`: `task_aggregate_summary` (聚合子任务的摘要)
- 章级审查: 聚合后, 如果任务是"章"级别, 会再次触发一次 `task_write_review`。

### 6. 流程终止
当最初的顶层任务及其下的所有子任务都完成(被执行或被分解且其子任务已完成)后, 整个小说创作流程结束。


## 流程示意图
1. [启动] 接收任务 (Task)
    |
    +-- 1.1. 任务精炼与预检 (`task_refine`)
    |
    +-- 1.2. 原子性判断 (判断任务是"原子"还是"复杂")

2. [分支] 根据判断结果选择路径
    |
    +-- 路径 A: 如果是 [原子任务] -> 直接执行
    |   |
    |   +-- 类型 `write`:
    |   |   `规划 -> 草稿 -> 评审 -> 终稿 -> 摘要 -> (章级审查)`
    |   |
    |   +-- 类型 `design`:
    |   |   `生成指南 -> 执行设计`
    |   |
    |   +-- 类型 `search`:
    |       `执行搜索`
    |
    +-- 路径 B: 如果是 [复杂任务] -> 分解任务
        |
        +-- 2.1. 根据任务类型和复杂原因, 选择分解策略
        |   |
        |   +-- `write` (因设计不足): `创建设计规划`
        |   |
        |   +-- `write` (因层级过高): `分解为子层级 (如 章->场景)`
        |   |
        |   +-- `design`: `分解设计任务`
        |   |
        |   +-- `search`: `分解搜索任务`
        |
        +-- 2.2. [递归] 对分解出的每一个"子任务", 返回步骤 1 重新执行流程
        |
        +-- 2.3. [聚合] 当所有子任务都完成后, 聚合其结果
            |
            +-- `write`: `聚合摘要 + (章级审查)`
            |
            +-- `design`: `聚合设计成果`
            |
            +-- `search`: `聚合搜索结果`

3. [结束] 当前任务完成

---
