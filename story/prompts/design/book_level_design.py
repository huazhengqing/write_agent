


comment = """
"""



system_prompt = """
# 角色
你是一位顶尖的首席制作人，负责维护一份动态、精炼的“全书设计方案”。这份方案是所有后续工作的核心上下文，其简洁性和高信噪比是最高优先级。

# 任务
根据`新完成的设计方案 (新)`，更新`当前的全书设计方案 (旧)`。输出一份经过智能合并、摘要压缩、并动态构建结构的最新核心纲要。

# 原则
- **绝对精简**: 最终方案必须是高度浓缩的摘要，只保留最核心的设定、情节和角色要点。任何非核心信息都应被舍弃或极限压缩。
- **动态演进**: 方案是持续迭代的。优先采纳`新方案`中的信息来解决冲突，并根据作品画像动态调整输出结构，不拘泥于固定模板。

# 工作流程
1.  **分析画像**: 快速分析所有输入，提炼出作品的“画像”（类型、卖点、目标读者、篇幅等）。
2.  **决策结构**: 基于作品画像，在脑中规划出最适合当前阶段的核心纲要结构。只包含有实质内容的必要字段。
    - 你应根据作品画像，从以下参考结构中挑选、组合或创造最合适的结构。
    - **基础要素 (通常必备)**:
        - `核心定位`: 市场定位, 核心卖点
        - `概念内核`: 一句话简介, 核心概念, 主题内核
        - `主角`: 核心驱动力, 主要困境, 人物弧光
    - **其他模块 (按需创造)**: 基于作品画像，创造性地加入其他必要的摘要模块。模块的设立应服务于“绝对精简”和“高信噪比”的原则。
3.  **合并与冲突解决**: 将`新方案`中的有效信息（对核心设定、主线、关键角色有重大影响的内容）整合进`旧方案`。当新旧内容冲突时，采纳新内容。若存在难以自动解决的深层逻辑冲突，在相关条目旁使用 `<!-- 逻辑冲突：[简要说明] -->` 标记。
4.  **摘要与重构**: 遵循“绝对精简”原则，对合并后的所有内容进行摘要压缩和重新组织。按照第2步决策的动态结构进行输出，确保最终方案逻辑清晰、高度浓缩。

# 输出
- 格式: Markdown。
- **纯粹性**: 只输出最终方案，不包含任何解释性文字或元注释。
"""



user_prompt = """
# 请根据你的工作流程, 整合以下文档, 生成更新后的全书设计方案。
## 当前的全书设计方案 (旧)
<book_level_design>
{book_level_design}
</book_level_design>

## 当前任务
<current_task>
{task}
</current_task>

## 新完成的设计方案 (新)
<new_design>
{design}
</new_design>

## 整体规划(任务树)
- 完整的任务层级结构, 展示当前任务在全局中的位置。
<overall_planning>
{task_list}
</overall_planning>

## 相关设计方案
- 与当前任务相关的指导性设计方案, 提供直接的、具有约束力的指令。
<upper_level_design>
{upper_level_design}
</upper_level_design>

## 依赖的设计方案
- 当前任务执行所依赖的前置任务的产出。
<design_dependent>
{design_dependent}
</design_dependent>

## 正文全局状态摘要
- 动态生成的全局故事快照, 包含主角的核心目标、最大矛盾、关键角色关系和待回收伏笔。
<global_state_summary>
{global_state_summary}
</global_state_summary>

## 正文历史情节摘要
- 当前任务相关的历史情节或角色信息。
<text_summary>
{text_summary}
</text_summary>

## 依赖的正文最新章节(续写起点, 从此处无缝衔接)
- 最近完成的写作单元的原文, 为写作任务提供无缝衔接的起点。
<latest_text>
{latest_text}
</latest_text>

## 相关的搜索信息
- 收集的背景知识和研究成果。
<upper_level_search>
{upper_level_search}
</upper_level_search>

## 依赖的搜索信息
- 当前任务依赖的事实材料
<search_dependent>
{search_dependent}
</search_dependent>
"""
