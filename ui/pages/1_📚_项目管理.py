import streamlit as st
import os
import sys

project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..'))
if project_root not in sys.path:
    sys.path.insert(0, project_root)

from ui.common import (
    get_all_books,
    sync_book_to_task_db,
    delete_project,
    get_meta_db,
    generate_idea,
    st_autoresize_text_area  # å¯¼å…¥æ–°çš„è‡ªåŠ¨é«˜åº¦ç»„ä»¶
)

def render_project_management_page():
    """æ¸²æŸ“é¡¹ç›®ç®¡ç†é¡µé¢"""
    st.header("ğŸ“š é¡¹ç›®ç®¡ç†")

    # åˆå§‹åŒ– session_state ç”¨äºæ§åˆ¶ç¼–è¾‘å¯¹è¯æ¡†
    if "editing_run_id" not in st.session_state:
        st.session_state.editing_run_id = None
    # åˆå§‹åŒ– session_state ç”¨äºå­˜å‚¨AIç”Ÿæˆçš„é¡¹ç›®ç‚¹å­
    if "generated_idea" not in st.session_state:
        st.session_state.generated_idea = {}

    with st.expander("â• åˆ›å»ºæ–°é¡¹ç›®", expanded=False):
        with st.form("new_project_form"):
            col1, col2 = st.columns([3, 1])
            with col1:
                st.subheader("å¡«å†™æ–°é¡¹ç›®ä¿¡æ¯")
            with col2:
                if st.form_submit_button("ğŸ¤– ç”Ÿæˆåˆ›æ„", use_container_width=True):
                    with st.spinner("æ­£åœ¨å‘AIè¯·æ±‚åˆ›æ„..."):
                        idea = generate_idea()
                        if idea:
                            st.session_state.generated_idea = idea.model_dump()
                            st.rerun()
                        else:
                            st.error("æ— æ³•ç”Ÿæˆåˆ›æ„ï¼Œè¯·ç¨åé‡è¯•ã€‚")

            # ä½¿ç”¨ session_state ä¸­çš„å€¼ä½œä¸ºé»˜è®¤å€¼
            name = st.text_input("ä¹¦å/é¡¹ç›®å", st.session_state.generated_idea.get("name", "æˆ‘é ç¾é£Ÿä¿®ç‚¼ï¼Œç«Ÿæˆäº†å›½è¿ä¹‹ç¥"))
            goal = st_autoresize_text_area("æ ¸å¿ƒç›®æ ‡", st.session_state.generated_idea.get("goal", "åœ¨ä¸€ä¸ªç¾é£Ÿèƒ½è§‰é†’â€˜é£Ÿçµâ€™ã€å½±å“å›½è¿çš„ç°ä»£éƒ½å¸‚ï¼Œä¸€ä¸ªèƒŒè´Ÿå®¶æ—è¡°è½ç§˜å¯†çš„é’å¹´å¨å¸ˆï¼Œæ„å¤–æ¿€æ´»äº†èƒ½â€˜è§£æä¸‡ç‰©â€™çš„ç¥ç§˜ç³»ç»Ÿã€‚ä»–ä»ä¸€é“å®¶ä¼ èœå¼€å§‹ï¼Œé€šè¿‡çƒ¹é¥ªæè‡´ç¾å‘³ï¼Œå”¤é†’æ²‰ç¡çš„é£Ÿçµï¼Œç§¯ç´¯ç¾é£Ÿæ°”è¿ï¼Œå…‘æ¢è¶…å‡¡èƒ½åŠ›ã€‚ä»–ä¸ä»…è¦é‡æŒ¯å®¶æ—è£è€€ï¼Œè¿˜è¦åœ¨å„å›½ç¾é£Ÿä¸–å®¶ã€ç¥ç§˜ç»„ç»‡å’Œå›½å®¶åŠ›é‡çš„åšå¼ˆä¸­ï¼Œæ­å¼€å¯¼è‡´ç¾é£Ÿæ–‡æ˜æ–­ä»£çš„å†å²çœŸç›¸ï¼Œæœ€ç»ˆä»¥ç¾é£Ÿä¹‹é“ï¼Œå®ˆæŠ¤å›½è¿ï¼Œç™»é¡¶ä¸–ç•Œä¹‹å·…ã€‚"), key="new_goal")
            category = st.selectbox("ç±»åˆ«", ["story", "report", "book"], index=0)
            language = st.selectbox("è¯­è¨€", ["cn", "en"], index=0)
            instructions = st_autoresize_text_area("å…·ä½“æŒ‡ä»¤", st.session_state.generated_idea.get("instructions", """
### 1. äº§å“å®šä½ä¸ç›®æ ‡è¯»è€…
- **ç›®æ ‡å¹³å°**: ç•ªèŒ„å°è¯´ã€èµ·ç‚¹ä¸­æ–‡ç½‘ã€‚å…¼é¡¾å…è´¹é˜…è¯»çš„å¿«èŠ‚å¥å’Œä»˜è´¹é˜…è¯»çš„æ·±åº¦è®¾å®šã€‚
- **æ ¸å¿ƒè¯»è€…**: 18-35å²ç”·æ€§è¯»è€…ï¼Œå¯¹ç³»ç»Ÿæµã€éƒ½å¸‚å¼‚èƒ½ã€ç¾é£Ÿæ–‡ã€å›½è¿å…ƒç´ æœ‰é˜…è¯»åå¥½ã€‚ä»–ä»¬è¿½æ±‚æ–°å¥‡è®¾å®šã€å¼ºçƒˆçš„çˆ½ç‚¹åé¦ˆå’Œæœ‰æ·±åº¦çš„æƒ…èŠ‚å¸ƒå±€ã€‚

### 2. æ•…äº‹é£æ ¼ä¸åŸºè°ƒ
- **æ•´ä½“é£æ ¼**: ç°ä»£éƒ½å¸‚å¹»æƒ³ï¼ŒèŠ‚å¥æ˜å¿«ï¼Œçˆ½ç‚¹å¯†é›†ã€‚
- **åŸºè°ƒ**: ä»¥è½»æ¾ã€çƒ­è¡€çš„æˆé•¿ä¸ºä¸»çº¿ï¼Œä¸­æœŸå¼•å…¥æ‚¬ç–‘å’Œæƒè°‹å…ƒç´ å¢åŠ æ•…äº‹å¼ åŠ›ã€‚ä¸»è§’æ€§æ ¼æ€ä¼æœæ–­ï¼Œæ™ºå•†åœ¨çº¿ï¼Œè¡Œä¸ºé€»è¾‘ç¬¦åˆâ€œç²¾è‡´åˆ©å·±ä¸»ä¹‰è€…â€çš„æˆé•¿è¿‡ç¨‹ã€‚

### 3. æ ¸å¿ƒçˆ½ç‚¹è®¾è®¡
- **ä¸»çˆ½ç‚¹ (ç³»ç»Ÿæˆé•¿)**:
  - **è§£æä¸‡ç‰©**: ç³»ç»Ÿèƒ½è§£æé£Ÿæã€èœè°±ã€å¯¹æ‰‹æŠ€èƒ½ï¼Œç”šè‡³å¤ä»£é—è¿¹ï¼Œæä¾›æœ€ä¼˜è§£ï¼Œå¸¦æ¥ä¿¡æ¯å·®ç¢¾å‹çš„å¿«æ„Ÿã€‚
  - **æ°”è¿å…‘æ¢**: çƒ¹é¥ªç¾é£Ÿè·å¾—â€œç¾é£Ÿæ°”è¿â€ï¼Œå…‘æ¢ç¨€æœ‰é£Ÿæã€ä¼ è¯´å¨å…·ã€å¼ºå¤§é£Ÿçµã€ç”šè‡³ä¸´æ—¶å›½è¿åŠ æŒã€‚
- **è¾…çˆ½ç‚¹ (æƒ…èŠ‚é©±åŠ¨)**:
  - **ç¾é£Ÿå¯¹å†³**: ä¸ä»…æ˜¯å¨è‰ºæ¯”æ‹¼ï¼Œæ›´æ˜¯â€œé£Ÿçµâ€çš„æˆ˜æ–—å’ŒèƒŒååŠ¿åŠ›çš„åšå¼ˆï¼Œåœºé¢å®å¤§ã€‚
  - **æ‰“è„¸é€†è¢­**: ä¸»è§’ä»ä¸€ä¸ªè½é­„å¨å¸ˆï¼Œä¸€æ­¥æ­¥æ‰“è„¸çœ‹ä¸èµ·ä»–çš„ç«äº‰å¯¹æ‰‹ã€ç¾é£Ÿä¸–å®¶å’Œæµ·å¤–æŒ‘æˆ˜è€…ã€‚
  - **æ¢ç´¢è§£è°œ**: æ­å¼€å®¶æ—è¡°è´¥ã€ç¾é£Ÿæ–‡æ˜æ–­ä»£çš„å†å²è°œå›¢ï¼Œè·å¾—å¤ä»£ä¼ æ‰¿å’Œå®è—ã€‚
  - **å›½è¿ä¹‹äº‰**: ä»¥ç¾é£Ÿå½±å“å›½è¿ï¼Œå‚ä¸å›½é™…çº§çš„ç¾é£Ÿç«èµ›ï¼Œä¸ºå›½äº‰å…‰ï¼Œè·å¾—å›½æ°‘å´‡æ‹œå’Œç°å®ä¸–ç•Œçš„å½±å“åŠ›ã€‚
"""), key="new_instructions")
            input_brief = st_autoresize_text_area("è¾“å…¥æŒ‡å¼•", st.session_state.generated_idea.get("input_brief", """
### 1. ä¸»è§’è®¾å®š (Character)
- **å§“å**: æ¥šæ›œ
- **èƒŒæ™¯**: æ›¾ç»æ˜¯åéœ‡ä¸€æ–¹çš„ç¾é£Ÿä¸–å®¶â€œæ¥šå®¶â€çš„å«¡ç³»ä¼ äººï¼Œä½†å®¶æ—åœ¨ä¸€å¤œä¹‹é—´ç¦»å¥‡è¡°è´¥ï¼Œçˆ¶æ¯å¤±è¸ªï¼Œä»–åªèƒ½åœ¨åŸå¸‚è§’è½å¼€ä¸€å®¶å°é¤é¦†å‹‰å¼ºåº¦æ—¥ï¼Œå¹¶å®ˆæŠ¤ç€å®¶æ—æœ€åçš„ç§˜å¯†ã€‚
- **æˆé•¿å¼§å…‰**:
  - **åˆå§‹ç¼ºé™· (Lie)**: â€œå®¶æ—çš„è¡°è´¥æ˜¯æˆ‘çš„åŸç½ªï¼Œæˆ‘åªèƒ½è‹Ÿä¸”å·ç”Ÿï¼Œæ— æ³•é‡ç°è¾‰ç…Œã€‚â€
  - **å¤–åœ¨æ¬²æœ› (Want)**: èµšé’±ï¼Œæ‰¾åˆ°çˆ¶æ¯ï¼Œé‡æŒ¯å®¶æ—ã€‚
  - **å†…åœ¨éœ€æ±‚ (Need)**: æ‰¾åˆ°è‡ªæˆ‘èº«ä»½è®¤åŒï¼Œä¸å†èƒŒè´Ÿå®¶æ—çš„æ²‰é‡æ·é”ï¼Œè€Œæ˜¯ä½œä¸ºâ€œæ¥šæ›œâ€è‡ªå·±ï¼Œå¼€åˆ›ä¸€æ¡å‰æ— å¤äººçš„ç¾é£Ÿä¹‹é“ï¼Œå¹¶æ‰¿æ‹…èµ·å®ˆæŠ¤å›½è¿çš„è´£ä»»ã€‚
- **é‡‘æ‰‹æŒ‡ (System)**:
  - **åç§°**: â€œé“â€ç³»ç»Ÿ (å†…éƒ¨ä»£å·ï¼ŒåˆæœŸè¡¨ç°ä¸ºè§£æèƒ½åŠ›)
  - **æ ¸å¿ƒæœºåˆ¶**:
    1. **è§£æ**: å¯è§£æä¸€åˆ‡ä¸â€œé£Ÿâ€ç›¸å…³äº‹ç‰©ã€‚è§£æé£Ÿæï¼Œå¯çŸ¥å…¶æœ€ä½³çƒ¹é¥ªæ–¹å¼ï¼›è§£æèœè°±ï¼Œå¯ä¼˜åŒ–æµç¨‹ï¼›è§£æå¯¹æ‰‹ï¼Œå¯çŸ¥å…¶å¨è‰ºå¼±ç‚¹ã€‚
    2. **æ¼”åŒ–**: éšç€ä¸»è§’çƒ¹é¥ªçš„èœå“ç­‰çº§å’Œè•´å«æ°”è¿çš„æå‡ï¼Œç³»ç»Ÿä¼šè§£é”æ–°åŠŸèƒ½ï¼Œå¦‚â€œæ°”è¿ç†”ç‚‰â€ï¼ˆå…‘æ¢ï¼‰ã€â€œé£Ÿçµç©ºé—´â€ï¼ˆåŸ¹å…»ï¼‰ã€â€œæ—¶ç©ºç§˜å¢ƒâ€ï¼ˆè·å–ç‰¹æ®Šé£Ÿæï¼‰ã€‚
  - **é™åˆ¶**: è§£æå’Œæ¼”åŒ–éœ€è¦æ¶ˆè€—ç²¾ç¥åŠ›å’Œâ€œç¾é£Ÿæ°”è¿â€ï¼Œè¿‡åº¦ä½¿ç”¨ä¼šå¯¼è‡´è™šå¼±ã€‚é«˜çº§ç‰©å“çš„å…‘æ¢æœ‰å‰ç½®æ¡ä»¶å’ŒæˆåŠŸç‡ã€‚

### 2. ä¸–ç•Œè§‚æ ¸å¿ƒè®¾å®š (World Building)
- **æ ¸å¿ƒæ¦‚å¿µ**: ç¾é£Ÿæ˜¯è¿æ¥ç‰©è´¨ä¸–ç•Œä¸ç²¾ç¥èƒ½é‡çš„æ¡¥æ¢ã€‚æè‡´çš„ç¾å‘³å¯ä»¥è¯ç”Ÿæ‹¥æœ‰è‡ªä¸»æ„è¯†çš„èƒ½é‡ä½“â€”â€”**é£Ÿçµ**ã€‚
- **ç‹¬ç‰¹æ³•åˆ™**:
  1. **é£Ÿçµå…±ç”Ÿ**: å¨å¸ˆå¯ä»¥é€šè¿‡è¡€è„‰æˆ–ç‰¹æ®Šä»ªå¼ä¸â€œé£Ÿçµâ€ç­¾è®¢å¥‘çº¦ï¼Œè·å¾—è¶…å‡¡å¨è‰ºå’Œæˆ˜æ–—åŠ›ã€‚å¼ºå¤§çš„é£Ÿçµç”šè‡³å¯ä»¥å½±å“ä¸€æ–¹æ°´åœŸçš„æ°”å€™ã€‚
  2. **ç¾é£Ÿæ°”è¿**: é£Ÿç‰©ä¸ä»…æä¾›èƒ½é‡ï¼Œè¿˜è•´å«â€œæ°”è¿â€ã€‚æ™®é€šé£Ÿç‰©æ»‹å…»ä¸ªäººï¼Œè€Œè•´å«å†å²æ–‡åŒ–ã€å›½æ°‘æƒ…æ„Ÿçš„â€œå›½èœâ€åˆ™ä¸å›½è¿ç›¸è¿ã€‚çƒ¹é¥ªæˆ–å“å°å›½èœï¼Œå¯ä»¥å¢å¼ºæˆ–å‰Šå¼±å›½è¿ã€‚
  3. **æ–‡æ˜æ–­ä»£**: å†å²ä¸Šæ›¾å­˜åœ¨ä¸€ä¸ªè¾‰ç…Œçš„ç¾é£Ÿæ–‡æ˜ï¼Œå¨å¸ˆèƒ½ç§»å±±å¡«æµ·ï¼Œé£Ÿçµå¯åª²ç¾ç¥æ˜ã€‚ä½†ä¸€åœºæœªçŸ¥çš„ç¾éš¾å¯¼è‡´äº†æ–‡æ˜æ–­ä»£ï¼Œå¤§éƒ¨åˆ†å¼ºå¤§çš„é£Ÿçµå’Œèœè°±å¤±ä¼ ï¼Œä¸»è§’çš„å®¶æ—ç§˜å¯†ä¸æ­¤ç›¸å…³ã€‚
- **èƒŒæ™¯è°œå›¢**:
  - æ¥šå®¶ä¸ºä½•ä¸€å¤œè¡°è´¥ï¼Ÿçˆ¶æ¯å¤±è¸ªæ˜¯å¦ä¸å®ˆæŠ¤çš„ç§˜å¯†æœ‰å…³ï¼Ÿ
  - å†å²ä¸Šçš„ç¾é£Ÿæ–‡æ˜æ–­ä»£æ˜¯å¤©ç¾è¿˜æ˜¯äººç¥¸ï¼Ÿ
  - æµ·å¤–ç¥ç§˜ç»„ç»‡ä¸ºä½•ä¹Ÿåœ¨å¯»æ‰¾å¤±è½çš„é£Ÿçµå’Œèœè°±ï¼Ÿ

### 3. é»„é‡‘ä¸‰ç« æ ¸å¿ƒæƒ…èŠ‚æ„æ€ (Opening Chapters)
**ç¬¬ä¸€ç« ï¼šã€æ·±å¤œé¤é¦†çš„ç¥ç§˜å®¢äººã€‘**
- **é’©å­**: æ·±å¤œï¼Œä¸€å®¶å³å°†å€’é—­çš„å°é¤é¦†ï¼Œä¸»è§’æ¥šæ›œä¸ºä¸€ä½ç¥ç§˜çš„ç™½å‘è€äººåšäº†ä¸€é“å®¶ä¼ çš„â€œé»¯ç„¶é”€é­‚é¥­â€ã€‚
- **å†²çª**: è€äººåƒåç«Ÿæ³ªæµæ»¡é¢ï¼Œå¼•å‘å¤©åœ°å¼‚è±¡ï¼Œæ¥šæ›œè„‘ä¸­ç³»ç»Ÿæ„å¤–æ¿€æ´»ï¼Œã€è§£æã€‘åŠŸèƒ½åˆæ¬¡ä¸Šçº¿ï¼Œæ˜¾ç¤ºâ€œé»¯ç„¶é”€é­‚é¥­â€è•´å«â€œé¾™è„‰æ°”è¿â€0.01%ã€‚æ­¤æ—¶ï¼ŒåŸä¸­ç¾é£Ÿåä¼šçš„æ‰§æ³•é˜Ÿé—¯å…¥ï¼ŒæŒ‡æ§ä»–éæ³•çƒ¹é¥ªâ€œç¦å¿Œèœè°±â€ã€‚
- **çˆ½ç‚¹**: ç³»ç»Ÿæ¿€æ´»çš„éœ‡æ’¼ï¼›å®¶ä¼ èœè°±çš„ç‰›é€¼èƒŒæ™¯ï¼›å¼€å±€å³é¢ä¸´é¡¶çº§åŠ¿åŠ›çš„å†²çªï¼Œæ‚¬å¿µæ‹‰æ»¡ã€‚

**ç¬¬äºŒç« ï¼šã€è§£æï¼è›‹ç‚’é¥­çš„åå…«ç§å˜åŒ–ã€‘**
- **é’©å­**: æ‰§æ³•é˜Ÿé˜Ÿé•¿ä¸ä¿¡é‚ªï¼Œè¦æ±‚æ¥šæ›œç°åœºåšä¸€é“æœ€ç®€å•çš„è›‹ç‚’é¥­æ¥è¯æ˜æ¸…ç™½ã€‚
- **å†²çª**: æ¥šæ›œåˆ©ç”¨ç³»ç»Ÿçš„è§£æèƒ½åŠ›ï¼Œç¬é—´æ´æ‚‰äº†å¯¹æ–¹çš„å‘³è§‰åå¥½ã€èº«ä½“çŠ¶å†µï¼Œå¹¶è§£æå‡ºæ™®é€šé£Ÿæçš„æœ€ä½³æ­é…ã€‚ä»–ç°åœºåšå‡ºäº†ä¸€ç¢—çœ‹ä¼¼å¹³å‡¡å´è®©é˜Ÿé•¿é£Ÿæ¬²å¤§å¼€ã€æš—ä¼¤ç—Šæ„ˆçš„â€œé»„é‡‘å¼€å£ç¬‘â€è›‹ç‚’é¥­ã€‚
- **çˆ½ç‚¹**: åˆ©ç”¨ç³»ç»Ÿä¿¡æ¯å·®çš„é™ç»´æ‰“å‡»ï¼›äºå¹³å‡¡ä¸­è§ç¥å¥‡çš„è£…é€¼å¿«æ„Ÿï¼›åŒ–è§£å±æœºå¹¶åå°†ä¸€å†›ï¼Œè®©æ‰§æ³•é˜Ÿé•¿æ¬ ä¸‹äººæƒ…ã€‚

**ç¬¬ä¸‰ç« ï¼šã€é£Ÿçµâ€˜é”…å·´â€™ï¼Œå‚è§ä¸»äººï¼ã€‘**
- **é’©å­**: è›‹ç‚’é¥­çš„æè‡´ç¾å‘³ï¼Œç«Ÿè®©é”…åº•å‰©ä¸‹çš„ä¸€å—é”…å·´è¯ç”Ÿäº†å¾®å¼±çš„çµæ™ºâ€”â€”è¿™æ˜¯é£Ÿçµè¯ç”Ÿçš„å‰å…†ï¼
- **å†²çª**: ç¥ç§˜è€äººæ­ç¤ºèº«ä»½ï¼Œæ˜¯å®ˆæŠ¤å›½è¿çš„â€œé¾™å¨â€ä¹‹ä¸€ï¼Œä»–ä¸€ç›´åœ¨å¯»æ‰¾èƒ½å”¤é†’é£Ÿçµçš„äººã€‚ä»–è­¦å‘Šæ¥šæ›œï¼Œä»–çš„èƒ½åŠ›å·²ç»å¼•èµ·äº†æµ·å¤–â€œé¥•é¤®è®®ä¼šâ€çš„æ³¨æ„ï¼Œå¹¶èµ äºˆä»–ä¸€å—èƒ½å¤Ÿéšè—æ°”æ¯çš„â€œé¾™é³â€ã€‚
- **çˆ½ç‚¹**: è·å¾—ç¬¬ä¸€ä¸ªï¼ˆæ½œåœ¨çš„ï¼‰é£Ÿçµï¼Œå¼€å¯å…»æˆçº¿ï¼›ä¸–ç•Œè§‚å®å¤§èƒŒæ™¯æ­å¼€ä¸€è§’ï¼›ä¸»è§’æ­£å¼è¸å…¥è¶…å‡¡ç¾é£Ÿä¸–ç•Œï¼Œè·å¾—æ–°æ‰‹å¯¼å¸ˆå’Œä¿å‘½é“å…·ã€‚
"""), key="new_input_brief")
            constraints = st_autoresize_text_area("é™åˆ¶å’Œç¦å¿Œ", st.session_state.generated_idea.get("constraints", """
### 1. ç«å“åˆ†æä¸å·®å¼‚åŒ–
- **å·®å¼‚åŒ–**:
  - **ä¸–ç•Œè§‚**: å¼•å…¥â€œé£Ÿçµâ€å’Œâ€œç¾é£Ÿæ–‡æ˜æ–­ä»£å²â€ï¼Œç›¸æ¯”ä¼ ç»Ÿç¾é£Ÿæ–‡ï¼Œå¢åŠ äº†å…»æˆå’Œæ¢ç´¢å…ƒç´ ï¼Œæ ¼å±€æ›´å®å¤§ã€‚
  - **é‡‘æ‰‹æŒ‡**: â€œè§£æâ€èƒ½åŠ›æ¯”ç®€å•çš„â€œå…‘æ¢â€æ›´å…·æ“ä½œæ„Ÿå’Œæ™ºæ…§æ„Ÿï¼Œä¸ºä¸»è§’çš„â€œæ™ºæ–—â€æƒ…èŠ‚æä¾›æ”¯æ’‘ã€‚
  - **æ ¸å¿ƒå†²çª**: ä»ä¸ªäººæ©æ€¨ã€å®¶æ—å¤å…´ä¸Šå‡åˆ°å›½è¿ä¹‹äº‰å’Œæ–‡æ˜ä¼ æ‰¿ï¼Œç›®æ ‡æ›´è¿œå¤§ã€‚

### 2. å¸‚åœºé£é™©ä¸è§„é¿ç­–ç•¥
- **é£é™©1 (è®¾å®šå¤æ‚)**: ä¸–ç•Œè§‚å’Œç³»ç»Ÿè®¾å®šè¾ƒå¤šï¼Œå¯èƒ½åŠé€€éƒ¨åˆ†åªæƒ³çœ‹å¿«èŠ‚å¥çˆ½æ–‡çš„è¯»è€…ã€‚
  - **è§„é¿**: ä¸åœ¨æ—©æœŸå †ç Œè®¾å®šã€‚é€šè¿‡â€œç¥ç§˜è€äººâ€çš„å£å’Œå…·ä½“æƒ…èŠ‚ï¼Œé€æ­¥ã€è‡ªç„¶åœ°æ­ç¤ºä¸–ç•Œè§‚ã€‚ç³»ç»ŸåŠŸèƒ½é€çº§è§£é”ï¼Œä¿æŒæ–°é²œæ„Ÿã€‚
- **é£é™©2 (é‡‘æ‰‹æŒ‡å¹³è¡¡)**: â€œè§£æâ€èƒ½åŠ›è¿‡å¼ºå¯èƒ½å¯¼è‡´ä¸»è§’æ— æ•Œï¼Œå¤±å»æˆé•¿æ„Ÿã€‚
  - **è§„é¿**: è®¾å®šç²¾ç¥åŠ›æ¶ˆè€—å’Œå†·å´æ—¶é—´ã€‚é«˜çº§ç›®æ ‡çš„è§£æéœ€è¦å‰ç½®æ¡ä»¶ï¼ˆå¦‚ç‰¹å®šé“å…·ã€è‡ªèº«å¨è‰ºç­‰çº§ï¼‰ã€‚å¼ºè°ƒè§£æåªæ˜¯æä¾›â€œæœ€ä¼˜è§£â€ï¼Œæ‰§è¡Œä»éœ€ä¸»è§’è‡ªèº«åŠªåŠ›å’ŒæŠ€å·§ã€‚
- **é£é™©3 (è¯»è€…æ¯’ç‚¹)**:
  - **åœ£æ¯/é™æ™º**: ä¸»è§’æ¥šæ›œè®¾å®šä¸ºæœ‰å®¶æ—ä»‡æ¨èƒŒæ™¯çš„ç°å®ä¸»ä¹‰è€…ï¼Œè¡Œäº‹ä»¥è‡ªèº«åˆ©ç›Šå’Œå¤ä»‡ä¸ºä¼˜å…ˆï¼Œä¸åœ£æ¯ï¼Œä¸æ— è„‘ã€‚
  - **æ„Ÿæƒ…çº¿**: æ„Ÿæƒ…çº¿ä¸ºè¾…ï¼Œå¯ä»¥æœ‰çº¢é¢œçŸ¥å·±ï¼Œä½†ç»ä¸æ‹–æ²“ï¼Œä¸å½±å“ä¸»çº¿èŠ‚å¥ã€‚å¥³æ€§è§’è‰²åº”ç‹¬ç«‹ã€æœ‰é­…åŠ›ï¼Œæ˜¯ä¼™ä¼´è€Œéé™„åº¸ã€‚
"""), key="new_constraints")
            acceptance_criteria = st_autoresize_text_area("éªŒæ”¶æ ‡å‡†", st.session_state.generated_idea.get("acceptance_criteria", """
1. **å¼€ç¯‡ç•™å­˜**: ä¸‰ç« å†…å¿…é¡»å®Œæˆä¸»è§’èƒŒæ™¯äº¤ä»£ã€é‡‘æ‰‹æŒ‡æ¿€æ´»ã€æ ¸å¿ƒæ‚¬å¿µï¼ˆå®¶æ—ä¹‹è°œã€å›½è¿ä¹‹äº‰ï¼‰çš„é“ºè®¾ï¼Œå¹¶è‡³å°‘å®Œæˆä¸€æ¬¡â€œæ‰“è„¸-è£…é€¼â€çš„å®Œæ•´çˆ½ç‚¹å¾ªç¯ã€‚è¯»è€…è¯„è®ºåŒºåº”å‡ºç°â€œå…»è‚¥â€ã€â€œè¿½äº†â€ç­‰æ­£é¢åé¦ˆã€‚
2. **è§’è‰²å¡‘é€ **: ä¸»è§’æ¥šæ›œçš„â€œèƒŒè´Ÿä»‡æ¨â€å’Œâ€œæ¸´æœ›å´›èµ·â€çš„å½¢è±¡å¿…é¡»åœ¨å¼€ç¯‡é€šè¿‡è¡ŒåŠ¨ï¼ˆè€Œéæ—ç™½ï¼‰é²œæ˜åœ°å»ºç«‹èµ·æ¥ã€‚
3. **çˆ½ç‚¹éªŒè¯**: â€œè§£æâ€èƒ½åŠ›çš„æ ¸å¿ƒçˆ½ç‚¹å¿…é¡»åœ¨ç¬¬äºŒç« å¾—åˆ°æ¸…æ™°å±•ç¤ºï¼Œå¹¶è¯æ˜å…¶åœ¨è§£å†³å†²çªä¸­çš„æœ‰æ•ˆæ€§å’Œå¼ºå¤§ä¹‹å¤„ã€‚
4. **ä¸–ç•Œè§‚å‘ˆç°**: â€œé£Ÿçµâ€æˆ–â€œç¾é£Ÿæ°”è¿â€çš„æ ¸å¿ƒæ¦‚å¿µå¿…é¡»åœ¨ç¬¬ä¸‰ç« é€šè¿‡å…·ä½“æƒ…èŠ‚ï¼ˆè€Œéè®¾å®šè½°ç‚¸ï¼‰å‘è¯»è€…æ­ç¤ºï¼Œå¹¶å¼•å‘è¯»è€…å¯¹åç»­ä¸–ç•Œçš„å¥½å¥‡ã€‚
5. **é’©å­å¼ºåº¦**: ç¬¬ä¸‰ç« ç»“å°¾å¿…é¡»ç•™ä¸‹ä¸€ä¸ªå¼ºæœ‰åŠ›çš„é’©å­ï¼Œä¾‹å¦‚â€œé¥•é¤®è®®ä¼šâ€çš„ç¬¬ä¸€ä¸ªæ•Œäººå·²ç»å‡ºç°ï¼Œæˆ–è€…ä¸»è§’æ¥åˆ°äº†ä¸€ä¸ªä¸å¯èƒ½å®Œæˆçš„æ–°æ‰‹ä»»åŠ¡ã€‚
"""), key="new_acceptance_criteria")
            length = st.text_input("é¢„ä¼°æ€»å­—æ•°", st.session_state.generated_idea.get("length", "100ä¸‡å­—"))

            submitted = st.form_submit_button("åˆ›å»ºé¡¹ç›®")
            if submitted:
                if not name or not goal:
                    st.error("ä¹¦åå’Œæ ¸å¿ƒç›®æ ‡ä¸èƒ½ä¸ºç©ºï¼")
                else:
                    book_info = {
                        'category': category, 'language': language, 'name': name,
                        'goal': goal, 'instructions': instructions, 'input_brief': input_brief,
                        'constraints': constraints, 'acceptance_criteria': acceptance_criteria,
                        'length': length
                    }
                    meta_db = get_meta_db()
                    meta_db.add_book(book_info)
                    st.success(f"é¡¹ç›®ã€Š{name}ã€‹å·²æˆåŠŸåˆ›å»ºï¼")
                    st.session_state.generated_idea = {} # æ¸…ç©ºå·²ç”Ÿæˆçš„ç‚¹å­
                    st.rerun()

    st.divider()

    st.subheader("é¡¹ç›®åˆ—è¡¨")
    all_books = get_all_books()
    if not all_books:
        st.info("å½“å‰æ²¡æœ‰é¡¹ç›®ã€‚è¯·åœ¨ä¸Šæ–¹åˆ›å»ºæ–°é¡¹ç›®æˆ–ç”Ÿæˆæµ‹è¯•æ•°æ®ã€‚")
    else:
        for i, book in enumerate(all_books):
            with st.expander(f"**{book.get('name', book.get('root_name', ''))}** (ID: {book['run_id']})", expanded=True):
                # å°†æ“ä½œæŒ‰é’®ç§»åŠ¨åˆ°è¡¨å•å¤–éƒ¨çš„é¡¶éƒ¨
                b1, b2, b3 = st.columns([1,1,2])
                with b1:
                    st.button("ğŸ”„ åŒæ­¥åˆ°ä»»åŠ¡åº“", key=f"sync_{book['run_id']}", on_click=sync_book_to_task_db, args=(book['run_id'],), use_container_width=True)
                with b2:
                    st.button("ğŸ—‘ï¸ åˆ é™¤æ­¤é¡¹ç›®", key=f"delete_{book['run_id']}", on_click=delete_project, args=(book['run_id'], book.get('name', book.get('root_name', ''))), use_container_width=True, type="secondary")

                with st.form(key=f"edit_form_{book['run_id']}"):
                    st.subheader(f"ç¼–è¾‘é¡¹ç›®: {book.get('name', book.get('root_name', ''))}")
                    
                    name = st.text_input("ä¹¦å/é¡¹ç›®å", value=book.get('name', book.get('root_name', '')), key=f"name_{book['run_id']}")
                    goal = st_autoresize_text_area("æ ¸å¿ƒç›®æ ‡", value=book.get('goal', ''), key=f"goal_{book['run_id']}")

                    c1, c2, c3, c4 = st.columns(4)
                    category = c1.selectbox("ç±»åˆ«", ["story", "report", "book"], index=["story", "report", "book"].index(book.get('category', 'story')), key=f"cat_{book['run_id']}")
                    language = c2.selectbox("è¯­è¨€", ["cn", "en"], index=["cn", "en"].index(book.get('language', 'cn')), key=f"lang_{book['run_id']}")
                    length = c3.text_input("é¢„ä¼°æ€»å­—æ•°", value=book.get('length', ''), key=f"len_{book['run_id']}")
                    day_wordcount_goal = c4.number_input("æ¯æ—¥å­—æ•°ç›®æ ‡", value=book.get('day_wordcount_goal', 0), key=f"day_wc_{book['run_id']}")

                    st.divider()
                    st.markdown("#### æ ¸å¿ƒåˆ›ä½œæŒ‡ä»¤")
                    instructions = st_autoresize_text_area("å…·ä½“æŒ‡ä»¤ (Instructions)", value=book.get('instructions', ''), key=f"instr_{book['run_id']}")
                    input_brief = st_autoresize_text_area("è¾“å…¥æŒ‡å¼• (Input Brief)", value=book.get('input_brief', ''), key=f"brief_{book['run_id']}")
                    constraints = st_autoresize_text_area("é™åˆ¶å’Œç¦å¿Œ (Constraints)", value=book.get('constraints', ''), key=f"constr_{book['run_id']}")
                    acceptance_criteria = st_autoresize_text_area("éªŒæ”¶æ ‡å‡† (Acceptance Criteria)", value=book.get('acceptance_criteria', ''), key=f"accept_{book['run_id']}")
                    
                    st.divider()
                    st.markdown("#### AIç”Ÿæˆå†…å®¹")
                    title = st.text_input("æ ‡é¢˜ (Title)", value=book.get('title', ''), key=f"title_{book['run_id']}") # æ ‡é¢˜é€šå¸¸æ˜¯å•è¡Œï¼Œä¿æŒ st.text_input
                    synopsis = st_autoresize_text_area("ç®€ä»‹ (Synopsis)", value=book.get('synopsis', ''), key=f"synopsis_{book['run_id']}") # å·²æ˜¯è‡ªåŠ¨é«˜åº¦
                    style = st_autoresize_text_area("é£æ ¼ (Style)", value=book.get('style', ''), key=f"style_{book['run_id']}") # å·²æ˜¯è‡ªåŠ¨é«˜åº¦
                    book_level_design = st_autoresize_text_area("å…¨ä¹¦è®¾è®¡ (Book Level Design)", value=book.get('book_level_design', ''), key=f"design_{book['run_id']}") # å·²æ˜¯è‡ªåŠ¨é«˜åº¦
                    global_state_summary = st_autoresize_text_area("å…¨å±€çŠ¶æ€ (Global State)", value=book.get('global_state_summary', ''), key=f"state_{book['run_id']}") # å·²æ˜¯è‡ªåŠ¨é«˜åº¦

                    st.divider()

                    # æ“ä½œæŒ‰é’®
                    submitted = st.form_submit_button("ğŸ’¾ ä¿å­˜ä¿®æ”¹", use_container_width=True, type="primary")
                    
                    if submitted:
                        updated_book_info = {
                            'name': name,
                            'goal': goal,
                            'category': category, 'language': language, 
                            'instructions': instructions, 'input_brief': input_brief,
                            'constraints': constraints, 'acceptance_criteria': acceptance_criteria,
                            'length': length, 'day_wordcount_goal': day_wordcount_goal,
                            'title': title, 'synopsis': synopsis, 'style': style,
                            'book_level_design': book_level_design, 'global_state_summary': global_state_summary
                        }
                        meta_db = get_meta_db()
                        meta_db.update_book(book['run_id'], updated_book_info)
                        st.success(f"é¡¹ç›®ã€Š{name}ã€‹å·²æˆåŠŸæ›´æ–°ï¼")
                        st.rerun()


st.set_page_config(layout="wide", page_title="é¡¹ç›®ç®¡ç†")
render_project_management_page()